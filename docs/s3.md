# S3 Storage Documentation

## Overview

OxUtils provides a comprehensive S3 storage system for Django applications with multiple storage backends optimized for different use cases. Built on `django-storages` and `boto3`, it offers separate storage classes for static files, public media, private media, and logs with automatic configuration and validation.

### Key Features

- **Multiple Storage Backends**: Four specialized storage classes for different needs
- **Automatic Configuration**: Environment-based configuration with validation
- **Access Control**: Configurable ACLs (public-read, private)
- **Signed URLs**: Automatic presigned URLs for private content
- **CDN Support**: Custom domain configuration for CloudFront/CDN
- **File Organization**: Automatic folder structure by storage type
- **Validation**: Built-in configuration validation with clear error messages

---

## Table of Contents

- [Architecture](#architecture)
- [Storage Classes](#storage-classes)
  - [StaticStorage](#staticstorage)
  - [PublicMediaStorage](#publicmediastorage)
  - [PrivateMediaStorage](#privatemediastorage)
  - [LogStorage](#logstorage)
- [Installation & Setup](#installation--setup)
- [Configuration](#configuration)
- [Usage Examples](#usage-examples)
- [Integration Patterns](#integration-patterns)
- [Security Best Practices](#security-best-practices)
- [Performance Optimization](#performance-optimization)
- [Troubleshooting](#troubleshooting)

---

## Architecture

### Storage Structure

```
S3 Bucket
├── static/              # StaticStorage
│   ├── css/
│   ├── js/
│   └── images/
├── media/               # PublicMediaStorage
│   ├── uploads/
│   ├── avatars/
│   └── documents/
├── private/             # PrivateMediaStorage
│   ├── invoices/
│   ├── contracts/
│   └── sensitive/
└── oxi_logs/           # LogStorage
    ├── service-a/
    ├── service-b/
    └── service-c/
```

### Storage Classes Overview

| Storage Class | Use Case | ACL | Signed URLs | Location |
|---------------|----------|-----|-------------|----------|
| **StaticStorage** | CSS, JS, images | public-read | No | `/static/` |
| **PublicMediaStorage** | User uploads, avatars | public-read | No | `/media/` |
| **PrivateMediaStorage** | Sensitive documents | private | Yes (1h) | `/private/` |
| **LogStorage** | Audit logs, exports | private | Yes (1h) | `/oxi_logs/{service}/` |

---

## Storage Classes

### StaticStorage

Storage backend for static files (CSS, JavaScript, images).

**Location:** `oxutils.s3.storages.StaticStorage`

#### Features

- **Public Access**: Files are publicly readable
- **No Overwrite**: Preserves existing files
- **CDN Ready**: Supports custom domains
- **Cache Control**: Configurable caching headers

#### Configuration

```python
# Environment variables
OXI_USE_STATIC_S3=True
OXI_STATIC_ACCESS_KEY_ID=your-access-key
OXI_STATIC_SECRET_ACCESS_KEY=your-secret-key
OXI_STATIC_STORAGE_BUCKET_NAME=your-bucket
OXI_STATIC_S3_CUSTOM_DOMAIN=cdn.example.com
OXI_STATIC_LOCATION=static
OXI_STATIC_DEFAULT_ACL=public-read
```

#### Django Settings

```python
# settings.py
STATICFILES_STORAGE = 'oxutils.s3.storages.StaticStorage'
STATIC_URL = f'https://{oxi_settings.static_s3_custom_domain}/{oxi_settings.static_location}/'
```

#### Usage

```python
# Collect static files to S3
python manage.py collectstatic --noinput

# In templates
{% load static %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<script src="{% static 'js/app.js' %}"></script>
```

---

### PublicMediaStorage

Storage backend for user-uploaded public media files.

**Location:** `oxutils.s3.storages.PublicMediaStorage`

#### Features

- **Public Access**: Files are publicly readable
- **User Uploads**: Handles file uploads from users
- **No Overwrite**: Prevents accidental overwrites
- **Flexible Configuration**: Can reuse static S3 credentials

#### Configuration

```python
# Environment variables
OXI_USE_DEFAULT_S3=True
OXI_DEFAULT_S3_ACCESS_KEY_ID=your-access-key
OXI_DEFAULT_S3_SECRET_ACCESS_KEY=your-secret-key
OXI_DEFAULT_S3_STORAGE_BUCKET_NAME=your-bucket
OXI_DEFAULT_S3_S3_CUSTOM_DOMAIN=cdn.example.com
OXI_DEFAULT_S3_LOCATION=media
OXI_DEFAULT_S3_DEFAULT_ACL=public-read

# Optional: Reuse static S3 credentials
OXI_USE_STATIC_S3_AS_DEFAULT=True
```

#### Django Settings

```python
# settings.py
DEFAULT_FILE_STORAGE = 'oxutils.s3.storages.PublicMediaStorage'
MEDIA_URL = f'https://{oxi_settings.default_s3_s3_custom_domain}/{oxi_settings.default_s3_location}/'
```

#### Usage

```python
# models.py
from django.db import models

class UserProfile(models.Model):
    avatar = models.ImageField(upload_to='avatars/')
    document = models.FileField(upload_to='documents/')

# In views
def upload_file(request):
    if request.method == 'POST':
        profile = UserProfile.objects.get(user=request.user)
        profile.avatar = request.FILES['avatar']
        profile.save()
        
        # File is automatically uploaded to S3
        print(profile.avatar.url)  # https://cdn.example.com/media/avatars/image.jpg
```

---

### PrivateMediaStorage

Storage backend for sensitive files requiring access control.

**Location:** `oxutils.s3.storages.PrivateMediaStorage`

#### Features

- **Private Access**: Files require authentication
- **Signed URLs**: Automatic presigned URLs (1 hour expiry)
- **Secure**: Not publicly accessible
- **No Overwrite**: Prevents accidental overwrites

#### Configuration

```python
# Environment variables
OXI_USE_PRIVATE_S3=True
OXI_PRIVATE_S3_ACCESS_KEY_ID=your-access-key
OXI_PRIVATE_S3_SECRET_ACCESS_KEY=your-secret-key
OXI_PRIVATE_S3_STORAGE_BUCKET_NAME=your-bucket
OXI_PRIVATE_S3_S3_CUSTOM_DOMAIN=s3.amazonaws.com
OXI_PRIVATE_S3_LOCATION=private
OXI_PRIVATE_S3_DEFAULT_ACL=private
```

#### Django Settings

```python
# settings.py
PRIVATE_FILE_STORAGE = 'oxutils.s3.storages.PrivateMediaStorage'
```

#### Usage

```python
# models.py
from django.db import models
from oxutils.s3.storages import PrivateMediaStorage

class Invoice(models.Model):
    pdf = models.FileField(
        storage=PrivateMediaStorage(),
        upload_to='invoices/'
    )

# In views
def download_invoice(request, invoice_id):
    invoice = Invoice.objects.get(id=invoice_id)
    
    # Get presigned URL (valid for 1 hour)
    url = invoice.pdf.url
    
    # Redirect to presigned URL
    return redirect(url)
```

---

### LogStorage

Storage backend for audit logs and exports.

**Location:** `oxutils.s3.storages.LogStorage`

#### Features

- **Private Access**: Logs are private by default
- **Signed URLs**: Automatic presigned URLs (1 hour expiry)
- **Service Organization**: Automatic folder per service
- **Secure**: Not publicly accessible
- **Audit Trail**: Ideal for compliance requirements

#### Configuration

```python
# Environment variables
OXI_USE_LOG_S3=True
OXI_LOG_S3_ACCESS_KEY_ID=your-access-key
OXI_LOG_S3_SECRET_ACCESS_KEY=your-secret-key
OXI_LOG_S3_STORAGE_BUCKET_NAME=your-bucket
OXI_LOG_S3_S3_CUSTOM_DOMAIN=s3.amazonaws.com
OXI_LOG_S3_LOCATION=oxi_logs
OXI_LOG_S3_DEFAULT_ACL=private
OXI_SERVICE_NAME=my-service

# Optional: Reuse private S3 credentials
OXI_USE_PRIVATE_S3_AS_LOG=True
```

#### Usage

```python
# In audit export
from oxutils.audit.models import LogExportState

export = LogExportState.create()
export.data.save('audit_logs.zip', content)
# Saved to: s3://bucket/oxi_logs/my-service/audit_logs.zip

# Access the file
url = export.data.url  # Presigned URL valid for 1 hour
```

---

## Installation & Setup

### Prerequisites

Install required dependencies:

```bash
pip install django-storages boto3
```

Or with uv:

```bash
uv add django-storages boto3
```

### Basic Setup

1. **Configure AWS credentials:**

```bash
# Option 1: Environment variables
export AWS_ACCESS_KEY_ID=your-access-key
export AWS_SECRET_ACCESS_KEY=your-secret-key

# Option 2: AWS credentials file (~/.aws/credentials)
[default]
aws_access_key_id = your-access-key
aws_secret_access_key = your-secret-key
```

2. **Enable S3 storage:**

```python
# settings.py or .env
OXI_USE_STATIC_S3=True
OXI_STATIC_STORAGE_BUCKET_NAME=my-bucket
OXI_STATIC_S3_CUSTOM_DOMAIN=my-bucket.s3.amazonaws.com
```

3. **Configure Django:**

```python
# settings.py
from oxutils.settings import oxi_settings

# Static files
if oxi_settings.use_static_s3:
    STATICFILES_STORAGE = 'oxutils.s3.storages.StaticStorage'
    STATIC_URL = f'https://{oxi_settings.static_s3_custom_domain}/{oxi_settings.static_location}/'

# Media files
if oxi_settings.use_default_s3:
    DEFAULT_FILE_STORAGE = 'oxutils.s3.storages.PublicMediaStorage'
    MEDIA_URL = f'https://{oxi_settings.default_s3_s3_custom_domain}/{oxi_settings.default_s3_location}/'
```

---

## Configuration

### Complete Configuration Reference

#### Static S3 Settings

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `OXI_USE_STATIC_S3` | `bool` | `False` | Enable static S3 storage |
| `OXI_STATIC_ACCESS_KEY_ID` | `str` | `None` | AWS access key ID |
| `OXI_STATIC_SECRET_ACCESS_KEY` | `str` | `None` | AWS secret access key |
| `OXI_STATIC_STORAGE_BUCKET_NAME` | `str` | `None` | S3 bucket name |
| `OXI_STATIC_DEFAULT_ACL` | `str` | `"public-read"` | Default ACL for files |
| `OXI_STATIC_S3_CUSTOM_DOMAIN` | `str` | `None` | Custom domain (CDN) |
| `OXI_STATIC_LOCATION` | `str` | `"static"` | Folder path in bucket |

#### Public Media S3 Settings

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `OXI_USE_DEFAULT_S3` | `bool` | `False` | Enable public media S3 storage |
| `OXI_USE_STATIC_S3_AS_DEFAULT` | `bool` | `False` | Reuse static S3 credentials |
| `OXI_DEFAULT_S3_ACCESS_KEY_ID` | `str` | `None` | AWS access key ID |
| `OXI_DEFAULT_S3_SECRET_ACCESS_KEY` | `str` | `None` | AWS secret access key |
| `OXI_DEFAULT_S3_STORAGE_BUCKET_NAME` | `str` | `None` | S3 bucket name |
| `OXI_DEFAULT_S3_DEFAULT_ACL` | `str` | `"public-read"` | Default ACL for files |
| `OXI_DEFAULT_S3_S3_CUSTOM_DOMAIN` | `str` | `None` | Custom domain (CDN) |
| `OXI_DEFAULT_S3_LOCATION` | `str` | `"media"` | Folder path in bucket |

#### Private Media S3 Settings

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `OXI_USE_PRIVATE_S3` | `bool` | `False` | Enable private media S3 storage |
| `OXI_PRIVATE_S3_ACCESS_KEY_ID` | `str` | `None` | AWS access key ID |
| `OXI_PRIVATE_S3_SECRET_ACCESS_KEY` | `str` | `None` | AWS secret access key |
| `OXI_PRIVATE_S3_STORAGE_BUCKET_NAME` | `str` | `None` | S3 bucket name |
| `OXI_PRIVATE_S3_DEFAULT_ACL` | `str` | `"private"` | Default ACL for files |
| `OXI_PRIVATE_S3_S3_CUSTOM_DOMAIN` | `str` | `None` | Custom domain |
| `OXI_PRIVATE_S3_LOCATION` | `str` | `"private"` | Folder path in bucket |

#### Log S3 Settings

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `OXI_USE_LOG_S3` | `bool` | `False` | Enable log S3 storage |
| `OXI_USE_PRIVATE_S3_AS_LOG` | `bool` | `False` | Reuse private S3 credentials |
| `OXI_LOG_S3_ACCESS_KEY_ID` | `str` | `None` | AWS access key ID |
| `OXI_LOG_S3_SECRET_ACCESS_KEY` | `str` | `None` | AWS secret access key |
| `OXI_LOG_S3_STORAGE_BUCKET_NAME` | `str` | `None` | S3 bucket name |
| `OXI_LOG_S3_DEFAULT_ACL` | `str` | `"private"` | Default ACL for files |
| `OXI_LOG_S3_S3_CUSTOM_DOMAIN` | `str` | `None` | Custom domain |
| `OXI_LOG_S3_LOCATION` | `str` | `"oxi_logs"` | Folder path in bucket |

---

## Usage Examples

### File Upload with Public Access

```python
# models.py
from django.db import models

class Product(models.Model):
    name = models.CharField(max_length=255)
    image = models.ImageField(upload_to='products/')
    
    def save(self, *args, **kwargs):
        super().save(*args, **kwargs)
        # Image is automatically uploaded to S3
        print(f"Image URL: {self.image.url}")

# views.py
from django.shortcuts import render
from django.core.files.storage import default_storage

def upload_product_image(request):
    if request.method == 'POST':
        image = request.FILES['image']
        
        # Save to S3
        path = default_storage.save(f'products/{image.name}', image)
        url = default_storage.url(path)
        
        return JsonResponse({'url': url})
```

### File Upload with Private Access

```python
# models.py
from django.db import models
from oxutils.s3.storages import PrivateMediaStorage

class Contract(models.Model):
    title = models.CharField(max_length=255)
    document = models.FileField(
        storage=PrivateMediaStorage(),
        upload_to='contracts/%Y/%m/'
    )
    
    def get_download_url(self):
        """Get presigned URL for download."""
        return self.document.url  # Valid for 1 hour

# views.py
from django.http import HttpResponse
from django.shortcuts import get_object_or_404

def download_contract(request, contract_id):
    contract = get_object_or_404(Contract, id=contract_id)
    
    # Check permissions
    if not request.user.has_perm('view_contract', contract):
        return HttpResponse('Unauthorized', status=403)
    
    # Redirect to presigned URL
    return redirect(contract.get_download_url())
```

### Direct S3 Operations

```python
from oxutils.s3.storages import PrivateMediaStorage
from django.core.files.base import ContentFile

# Initialize storage
storage = PrivateMediaStorage()

# Save file
content = ContentFile(b'File content here')
path = storage.save('documents/file.txt', content)

# Get URL (presigned for private storage)
url = storage.url(path)

# Check if file exists
exists = storage.exists('documents/file.txt')

# Get file size
size = storage.size('documents/file.txt')

# List files
files = storage.listdir('documents/')

# Delete file
storage.delete('documents/file.txt')
```

### Temporary File Upload

```python
from django.core.files.uploadedfile import InMemoryUploadedFile
from oxutils.s3.storages import PublicMediaStorage
import io

def generate_and_upload_report(data):
    """Generate report and upload to S3."""
    # Generate report
    report_content = generate_report(data)
    
    # Create in-memory file
    file_buffer = io.BytesIO(report_content.encode())
    uploaded_file = InMemoryUploadedFile(
        file_buffer,
        None,
        'report.pdf',
        'application/pdf',
        len(report_content),
        None
    )
    
    # Upload to S3
    storage = PublicMediaStorage()
    path = storage.save('reports/report.pdf', uploaded_file)
    
    return storage.url(path)
```

---

## Integration Patterns

### Multi-Storage Model

```python
from django.db import models
from oxutils.s3.storages import PublicMediaStorage, PrivateMediaStorage

class Document(models.Model):
    """Document with public thumbnail and private original."""
    title = models.CharField(max_length=255)
    
    # Public thumbnail
    thumbnail = models.ImageField(
        storage=PublicMediaStorage(),
        upload_to='thumbnails/'
    )
    
    # Private original
    original = models.FileField(
        storage=PrivateMediaStorage(),
        upload_to='documents/originals/'
    )
    
    def get_public_url(self):
        """Get public thumbnail URL."""
        return self.thumbnail.url
    
    def get_private_url(self):
        """Get presigned URL for original."""
        return self.original.url
```

### Custom Upload Path

```python
from django.db import models
from django.utils import timezone

def user_directory_path(instance, filename):
    """Generate upload path based on user and date."""
    return f'users/{instance.user.id}/{timezone.now().year}/{filename}'

class UserDocument(models.Model):
    user = models.ForeignKey('auth.User', on_delete=models.CASCADE)
    file = models.FileField(upload_to=user_directory_path)
```

### Conditional Storage

```python
from django.db import models
from oxutils.s3.storages import PublicMediaStorage, PrivateMediaStorage

def get_storage(is_public=True):
    """Get storage based on visibility."""
    return PublicMediaStorage() if is_public else PrivateMediaStorage()

class File(models.Model):
    name = models.CharField(max_length=255)
    is_public = models.BooleanField(default=True)
    file = models.FileField(storage=get_storage)
    
    def save(self, *args, **kwargs):
        # Set storage based on is_public
        self.file.storage = get_storage(self.is_public)
        super().save(*args, **kwargs)
```

### Bulk Upload

```python
from django.core.files.base import ContentFile
from oxutils.s3.storages import PublicMediaStorage

def bulk_upload_images(images: list):
    """Upload multiple images to S3."""
    storage = PublicMediaStorage()
    uploaded_urls = []
    
    for image in images:
        # Generate unique filename
        filename = f'bulk/{uuid.uuid4()}.jpg'
        
        # Upload to S3
        path = storage.save(filename, ContentFile(image))
        url = storage.url(path)
        
        uploaded_urls.append(url)
    
    return uploaded_urls
```

---

## Security Best Practices

### 1. Use Appropriate ACLs

```python
# ✅ Good - Public files use public-read
OXI_STATIC_DEFAULT_ACL=public-read
OXI_DEFAULT_S3_DEFAULT_ACL=public-read

# ✅ Good - Sensitive files use private
OXI_PRIVATE_S3_DEFAULT_ACL=private
OXI_LOG_S3_DEFAULT_ACL=private
```

### 2. Validate File Types

```python
from django.core.exceptions import ValidationError

def validate_file_extension(value):
    """Validate file extension."""
    import os
    ext = os.path.splitext(value.name)[1]
    valid_extensions = ['.pdf', '.doc', '.docx']
    
    if ext.lower() not in valid_extensions:
        raise ValidationError('Unsupported file extension.')

class Document(models.Model):
    file = models.FileField(
        validators=[validate_file_extension],
        upload_to='documents/'
    )
```

### 3. Limit File Size

```python
from django.core.exceptions import ValidationError

def validate_file_size(value):
    """Validate file size (max 10MB)."""
    filesize = value.size
    
    if filesize > 10 * 1024 * 1024:  # 10MB
        raise ValidationError('File size must be less than 10MB.')

class Upload(models.Model):
    file = models.FileField(
        validators=[validate_file_size],
        upload_to='uploads/'
    )
```

### 4. Sanitize Filenames

```python
import re
from django.utils.text import slugify

def sanitize_filename(filename):
    """Sanitize filename for S3."""
    name, ext = os.path.splitext(filename)
    name = slugify(name)
    return f"{name}{ext}"

def upload_to_sanitized(instance, filename):
    """Upload with sanitized filename."""
    return f'uploads/{sanitize_filename(filename)}'

class Upload(models.Model):
    file = models.FileField(upload_to=upload_to_sanitized)
```

### 5. Implement Access Control

```python
from django.http import HttpResponse
from django.shortcuts import get_object_or_404

def download_file(request, file_id):
    """Download file with access control."""
    file_obj = get_object_or_404(File, id=file_id)
    
    # Check permissions
    if file_obj.user != request.user:
        return HttpResponse('Unauthorized', status=403)
    
    # Generate presigned URL
    url = file_obj.file.url
    
    # Redirect to presigned URL
    return redirect(url)
```

### 6. Use HTTPS Only

```python
# settings.py
AWS_S3_SECURE_URLS = True
AWS_S3_USE_SSL = True
```

---

## Performance Optimization

### 1. Enable CloudFront CDN

```python
# Environment variables
OXI_STATIC_S3_CUSTOM_DOMAIN=d111111abcdef8.cloudfront.net
OXI_DEFAULT_S3_S3_CUSTOM_DOMAIN=d222222abcdef8.cloudfront.net
```

### 2. Configure Cache Headers

```python
# settings.py
AWS_S3_OBJECT_PARAMETERS = {
    'CacheControl': 'max-age=86400',  # 24 hours
}

# For static files
AWS_STATIC_OBJECT_PARAMETERS = {
    'CacheControl': 'max-age=31536000',  # 1 year
}
```

### 3. Use Multipart Upload for Large Files

```python
from storages.backends.s3boto3 import S3Boto3Storage

class OptimizedStorage(S3Boto3Storage):
    # Enable multipart upload for files > 5MB
    AWS_S3_MAX_MEMORY_SIZE = 5 * 1024 * 1024
```

### 4. Compress Files Before Upload

```python
import gzip
from django.core.files.base import ContentFile

def upload_compressed(storage, path, content):
    """Upload compressed file to S3."""
    compressed = gzip.compress(content.encode())
    
    storage.save(
        path,
        ContentFile(compressed),
        extra_args={'ContentEncoding': 'gzip'}
    )
```

### 5. Use Transfer Acceleration

```python
# settings.py
AWS_S3_USE_ACCELERATE_ENDPOINT = True
```

---

## Troubleshooting

### Common Issues

#### 1. "ImproperlyConfigured: StaticStorage requires OXI_USE_STATIC_S3=True"

**Cause:** Storage class used without enabling it

**Solution:**
```bash
export OXI_USE_STATIC_S3=True
export OXI_STATIC_STORAGE_BUCKET_NAME=my-bucket
export OXI_STATIC_S3_CUSTOM_DOMAIN=my-bucket.s3.amazonaws.com
```

#### 2. "ImproperlyConfigured: StaticStorage is missing required configuration"

**Cause:** Missing required credentials

**Solution:**
```bash
export OXI_STATIC_ACCESS_KEY_ID=your-access-key
export OXI_STATIC_SECRET_ACCESS_KEY=your-secret-key
export OXI_STATIC_STORAGE_BUCKET_NAME=your-bucket
export OXI_STATIC_S3_CUSTOM_DOMAIN=your-domain
```

#### 3. "Access Denied" Error

**Cause:** Insufficient IAM permissions

**Solution:** Ensure IAM user has these permissions:
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::your-bucket/*",
        "arn:aws:s3:::your-bucket"
      ]
    }
  ]
}
```

#### 4. Files Not Accessible

**Cause:** Incorrect ACL or bucket policy

**Solution:**
```python
# For public files
OXI_STATIC_DEFAULT_ACL=public-read

# Check bucket policy allows public read
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::your-bucket/static/*"
    }
  ]
}
```

#### 5. Slow Upload/Download

**Cause:** Not using CDN or transfer acceleration

**Solution:**
```python
# Enable CloudFront
OXI_STATIC_S3_CUSTOM_DOMAIN=d111111abcdef8.cloudfront.net

# Enable transfer acceleration
AWS_S3_USE_ACCELERATE_ENDPOINT=True
```

### Debugging

**Test S3 connection:**

```python
from oxutils.s3.storages import StaticStorage

storage = StaticStorage()

# Test write
from django.core.files.base import ContentFile
path = storage.save('test.txt', ContentFile(b'test'))
print(f"Saved to: {path}")

# Test read
content = storage.open(path).read()
print(f"Content: {content}")

# Test URL
url = storage.url(path)
print(f"URL: {url}")

# Test delete
storage.delete(path)
print("Deleted successfully")
```

**Check bucket permissions:**

```bash
aws s3 ls s3://your-bucket/
aws s3 cp test.txt s3://your-bucket/test.txt
aws s3 rm s3://your-bucket/test.txt
```

---

## Migration Guide

### From Local Storage to S3

1. **Backup existing files:**

```bash
tar -czf media_backup.tar.gz media/
```

2. **Configure S3:**

```python
# settings.py
OXI_USE_DEFAULT_S3=True
OXI_DEFAULT_S3_STORAGE_BUCKET_NAME=my-bucket
# ... other settings
```

3. **Upload existing files:**

```bash
aws s3 sync media/ s3://my-bucket/media/
```

4. **Update Django settings:**

```python
DEFAULT_FILE_STORAGE = 'oxutils.s3.storages.PublicMediaStorage'
```

5. **Test thoroughly:**

```python
# Test file access
from myapp.models import MyModel
obj = MyModel.objects.first()
print(obj.file.url)  # Should be S3 URL
```

---

## Related Documentation

- [Audit System](./audit.md) - LogStorage usage and log export
- [Settings & Configuration](./settings.md) - S3 configuration options
- [Mixins](./mixins.md) - Model mixins with file fields

---

## Support

For questions or issues regarding S3 storage, please contact the Oxiliere development team or open an issue in the repository.
