# S3 Storage

**Four specialized storage backends for Django**

## Storage Classes

| Class | Use Case | ACL | Signed URLs |
|-------|----------|-----|-------------|
| `StaticStorage` | CSS, JS, images | public-read | No |
| `PublicMediaStorage` | User uploads | public-read | No |
| `PrivateMediaStorage` | Sensitive files | private | Yes (1h) |
| `LogStorage` | Audit logs | private | Yes (1h) |

## Configuration

### Static S3

```bash
OXI_USE_STATIC_S3=True
OXI_STATIC_ACCESS_KEY_ID=your-key
OXI_STATIC_SECRET_ACCESS_KEY=your-secret
OXI_STATIC_STORAGE_BUCKET_NAME=my-bucket
OXI_STATIC_S3_CUSTOM_DOMAIN=cdn.example.com
```

### Public Media S3

```bash
OXI_USE_DEFAULT_S3=True
# Or reuse static credentials
OXI_USE_STATIC_S3_AS_DEFAULT=True
```

### Private Media S3

```bash
OXI_USE_PRIVATE_S3=True
OXI_PRIVATE_S3_STORAGE_BUCKET_NAME=private-bucket
OXI_PRIVATE_S3_DEFAULT_ACL=private
```

### Log S3

```bash
OXI_USE_LOG_S3=True
# Or reuse private credentials
OXI_USE_PRIVATE_S3_AS_LOG=True
```

## Usage

### Static Files

```python
# settings.py
STATICFILES_STORAGE = 'oxutils.s3.storages.StaticStorage'

# Collect static
python manage.py collectstatic
```

### Public Media

```python
# models.py
class UserProfile(models.Model):
    avatar = models.ImageField(upload_to='avatars/')

# File automatically uploaded to S3
profile.avatar = request.FILES['avatar']
profile.save()
print(profile.avatar.url)  # https://cdn.example.com/media/avatars/image.jpg
```

### Private Media

```python
# models.py
from oxutils.s3.storages import PrivateMediaStorage

class Invoice(models.Model):
    pdf = models.FileField(
        storage=PrivateMediaStorage(),
        upload_to='invoices/'
    )

# Get presigned URL (valid 1 hour)
url = invoice.pdf.url
```

### Log Storage

```python
from oxutils.audit.models import LogExportState

export = LogExportState.create()
export.data.save('audit_logs.zip', content)
# Saved to: s3://bucket/oxi_logs/my-service/audit_logs.zip

url = export.data.url  # Presigned URL
```

## Direct S3 Operations

```python
from oxutils.s3.storages import PrivateMediaStorage
from django.core.files.base import ContentFile

storage = PrivateMediaStorage()

# Save
path = storage.save('file.txt', ContentFile(b'content'))

# Get URL
url = storage.url(path)

# Check exists
exists = storage.exists('file.txt')

# Delete
storage.delete('file.txt')
```

## Security

### File Validation

```python
from django.core.exceptions import ValidationError

def validate_file_size(value):
    if value.size > 10 * 1024 * 1024:  # 10MB
        raise ValidationError('File too large')

class Upload(models.Model):
    file = models.FileField(validators=[validate_file_size])
```

### Access Control

```python
def download_file(request, file_id):
    file_obj = get_object_or_404(File, id=file_id)
    
    # Check permissions
    if file_obj.user \!= request.user:
        return HttpResponse('Unauthorized', status=403)
    
    # Redirect to presigned URL
    return redirect(file_obj.file.url)
```

## IAM Permissions

```json
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": [
      "s3:PutObject",
      "s3:GetObject",
      "s3:DeleteObject",
      "s3:ListBucket"
    ],
    "Resource": [
      "arn:aws:s3:::your-bucket/*",
      "arn:aws:s3:::your-bucket"
    ]
  }]
}
```

## Related Docs

- [Settings](./settings.md) - S3 configuration
- [Audit](./audit.md) - Log storage usage
